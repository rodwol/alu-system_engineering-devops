#!/usr/bin/env bash
# Install load balancer

echo -e "Updating and doing some minor checks...\n"

function install() {
  command -v "$1" &> /dev/null

  # shellcheck disable=SC2181
  if [ $? -ne 0 ]; then
    echo -e "	Installing: $1\n"
    sudo apt-get update -y -qq && \
      sudo apt-get install -y "$1" -qq
    echo -e "\n"
  else
    echo -e "	${1} is already installed.\n"
  fi
}

install haproxy #install haproxy

echo -e "\nSetting up some minor stuff.\n"

# Backup default server config file
sudo cp /etc/haproxy/haproxy.cfg haproxy_default.backup

# Define server configuration (improved readability)
server_config=$(cat <<EOF
defaults
  mode http
  timeout client 15s
  timeout connect 10s
  timeout server 15s
  timeout http-request 10s

<<<<<<< HEAD
frontend davidniyonshuti-tech-frontend
  bind *:80
  default_backend davidniyonshuti-tech-backend

backend davidniyonshuti-tech-backend
  balance roundrobin
  server 6050-web-01 107.23.166.233:80 check
  server 6050-web-02 54.196.146.125:80 check
EOF
)
=======
frontend hi-tech-frontend
    bind *:80
    default_backend hi-tech-backend

backend h-tech-backend
    balance roundrobin
    server 6160-web-01 54.86.211.123:80 check
    server 6160-web-02 100.27.210.129:80 check
"
>>>>>>> 65325f07d8945d973783427f443e96998f46be0e

# Write configuration using standard method (cat + sudo tee)
echo "$server_config" | sudo tee /etc/haproxy/haproxy.cfg

# Enable haproxy to be started by init script
echo "ENABLED=1" | sudo tee /etc/default/haproxy

echo "Configured - Roundrobin On web-01 & web-02"

if [ "$(pgrep -c haproxy)" -le 0 ]; then
  sudo service haproxy start
else
  sudo service haproxy restart
fi
